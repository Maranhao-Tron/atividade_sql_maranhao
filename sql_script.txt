/* SQL SCRIPT - ATIVIDADE SQL + FIREBIRD */

/* DOMAINS */
CREATE DOMAIN "DM_ID" AS INTEGER;
CREATE DOMAIN "DM_STRING" AS VARCHAR(30);

/* CRIAÇÃO DE TABELAS */
CREATE TABLE PRODUTOS (
	PRO_ID DM_ID NOT NULL,
	PRO_NOME DM_STRING NOT NULL,
	PRO_DESC VARCHAR(60),
	PRO_PRECO_CUSTO NUMERIC(8,2) NOT NULL,
	PRO_PRECO_VENDA NUMERIC(8,2) NOT NULL,
	PRO_QTD INTEGER,
	PRO_FORNECEDOR DM_STRING,
	CONSTRAINT PK_PRODUTO PRIMARY KEY (PRO_ID, PRO_NOME)	
);

CREATE TABLE CLIENTES (
	CLI_ID DM_ID PRIMARY KEY,
	CLI_NOME DM_STRING NOT NULL,
	CLI_CPF_CNPJ VARCHAR(11) UNIQUE NOT NULL,
	CLI_ENDEDERCO VARCHAR(60),
	CLI_TELEFONE VARCHAR(13),
	CLI_EMAIL DM_STRING UNIQUE,
	CLI_DT_NASC DATE
);

CREATE TABLE VENDAS (
	VEN_ID DM_ID PRIMARY KEY,
	VEN_DATA DATE,
	VEN_CLIENTE_ID DM_ID,
	VEN_VENDEDOR DM_STRING,
	VEN_PRO_NOME DM_STRING,
	VEN_PRO_ID DM_ID,
	VEN_QTD INTEGER,
	VEN_VALOR_TOTAL NUMERIC(8,2),
	VEN_DESCONTO NUMERIC(8,2),
	VEN_FORMA_PGTO VARCHAR(20)
);

CREATE TABLE COMPRAS (
	CMP_ID DM_ID PRIMARY KEY,
	CMP_DATA DATE,
	CMP_FORNECEDOR DM_STRING,
	CMP_PRO_NOME DM_STRING,
	CMP_PRO_ID DM_ID,
	CMP_QTD INTEGER,
	CMP_FORMA_PGTO VARCHAR(20),
	CMP_PRAZO_ENTREGA VARCHAR(30)
);



CREATE TABLE USERS (
	USER_ID DM_ID NOT NULL,
	USER_NAME DM_STRING NOT NULL,
	USER_EMAIL DM_STRING,
	USER_ACTIVE SMALLINT NOT NULL CHECK (USER_ACTIVE IN (0, 1)),
	USER_PERM_ID INTEGER NOT NULL CHECK (USER_ACTIVE IN (1, 2, 3, 4)),
	USER_PASSWORD VARCHAR(60) UNIQUE,
	PRIMARY KEY (USER_ID, USER_NAME)
);

ALTER TABLE VENDAS
ADD CONSTRAINT FK_CLI_ID
FOREIGN KEY (VEN_CLIENTE_ID)
REFERENCES CLIENTES (CLI_ID);

ALTER TABLE VENDAS
ADD CONSTRAINT FK_PRODUTO_VENDA
FOREIGN KEY (VEN_PRO_ID, VEN_PRO_NOME)
REFERENCES PRODUTOS (PRO_ID, PRO_NOME);

ALTER TABLE COMPRAS
ADD CONSTRAINT FK_PRODUTO_COMPRA
FOREIGN KEY (CMP_PRO_ID, CMP_PRO_NOME)
REFERENCES PRODUTOS (PRO_ID, PRO_NOME);

/* TRIGGER PRODUTO */
CREATE GENERATOR GEN_PRODUTO_ID;

CREATE TRIGGER TRG_PRO_BI FOR PRODUTOS
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
    NEW.PRO_ID = GEN_ID(GEN_PRODUTO_ID, 1);
END

/* TRIGGER VENDA */
CREATE GENERATOR GEN_VENDA_ID;

CREATE TRIGGER TRG_VEN_BI FOR VENDAS
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
    NEW.VEN_ID = GEN_ID(GEN_VENDA_ID, 1);
END

/* TRIGGER COMPRAS */
CREATE GENERATOR GEN_COMPRA_ID;

CREATE TRIGGER TRG_CMP_BI FOR COMPRAS
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
    NEW.CMP_ID = GEN_ID(GEN_COMPRA_ID, 1);
END

/* TRIGGER USER */
CREATE GENERATOR GEN_USER_ID;

CREATE TRIGGER TRG_USERS_BI FOR USERS
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
    NEW.USER_ID = GEN_ID(GEN_USER_ID, 1);
END