/* CALCULA A COMISSÃO DOS VENDEDORES DE ACORDO COM O PERÍODO INSERIDO COMO ENTRADA */
CREATE PROCEDURE CALC_COMISSAO_VENDEDORES (
    P_DATA_INICIO DATE,
    P_DATA_FIM DATE
)
RETURNS (
    NOME_VENDEDOR VARCHAR(30),
    TOTAL_VENDAS DECIMAL(12,2),
    COMISSAO DECIMAL(12,2)
)
AS
BEGIN
    FOR 
        SELECT VEN_VENDEDOR, 
               SUM(VEN_VALOR_TOTAL) AS TOTAL_VENDAS,
               SUM(VEN_VALOR_TOTAL) * 0.05 AS COMISSAO
        FROM VENDAS
        WHERE VEN_DATA BETWEEN :P_DATA_INICIO AND :P_DATA_FIM
        GROUP BY VEN_VENDEDOR
    INTO 
        :NOME_VENDEDOR,
        :TOTAL_VENDAS, 
        :COMISSAO
    DO
        SUSPEND;
END

SELECT * FROM CALC_COMISSAO_VENDEDORES('2025-03-01', '2025-04-02');


/* RETORNA EM ORDEM DESCRESCENTE O VALOR TOTAL DE COMPRA FEITO POR CADA CLIENTE */
CREATE PROCEDURE RANK_QTD_COMPRAS_CLIENTE()
RETURNS (
    CLIENTE_ID INTEGER,
    NOME_CLIENTE VARCHAR(50),
    QUANTIDADE_COMPRAS INTEGER,
    VALOR_TOTAL NUMERIC(8,2)
)
AS
BEGIN
    FOR
        SELECT 
            C.CLI_ID, 
            C.CLI_NOME, 
            COUNT(V.VEN_ID) AS QUANTIDADE_COMPRAS,
            SUM(V.VEN_VALOR_TOTAL) AS VALOR_TOTAL
        FROM VENDAS V
        JOIN CLIENTES C ON V.VEN_CLIENTE_ID = C.CLI_ID
        GROUP BY C.CLI_ID, C.CLI_NOME
        ORDER BY QUANTIDADE_COMPRAS DESC, VALOR_TOTAL DESC
    INTO
        :CLIENTE_ID,
        :NOME_CLIENTE,
        :QUANTIDADE_COMPRAS,
        :VALOR_TOTAL
    DO
    BEGIN
        SUSPEND;
    END
END

SELECT * FROM RANK_QTD_COMPRAS_CLIENTE;


/* RETORNA EM ORDEM DECRESCENTE OS A QUANTIDADE DE VEZES QUE CADA CLIENTE REALIZOU UMA COMPRA */
CREATE PROCEDURE RANK_VALOR_COMPRA_CLIENTE()
RETURNS (
    CLIENTE_ID INTEGER,
    NOME_CLIENTE VARCHAR(50),
    VALOR_TOTAL NUMERIC(8,2)
)
AS
BEGIN
    FOR
        SELECT C.CLI_ID, C.CLI_NOME, SUM(V.VEN_VALOR_TOTAL) AS VALOR_TOTAL
        FROM VENDAS V
        JOIN CLIENTES C ON V.VEN_CLIENTE_ID = C.CLI_ID
        GROUP BY C.CLI_ID, C.CLI_NOME
        ORDER BY VALOR_TOTAL DESC
    INTO
        :CLIENTE_ID,
        :NOME_CLIENTE,
        :VALOR_TOTAL
    DO
    BEGIN
        SUSPEND;
    END
END

SELECT * FROM RANK_VALOR_COMPRA_CLIENTE;


/* RETORNA O HISTÓRIO DE VENDA DO CLIENTE INSERIDO COMO ENTRADA (ID DO CLIENTE) */
CREATE PROCEDURE HIST_VENDAS_CLIENTE (
	P_ID_CLIENTE INTEGER
)
RETURNS (
    NOME_CLIENTE VARCHAR(50),
    VENDA_ID INTEGER,
    PRODUTO VARCHAR(30),
    VALOR_TOTAL NUMERIC(8,2),
    DATA_VENDA DATE
)
AS
BEGIN
    FOR
        SELECT C.CLI_NOME, V.VEN_ID, V.VEN_PRO_NOME, V.VEN_VALOR_TOTAL, V.VEN_DATA
        FROM VENDAS V
        JOIN CLIENTES C ON V.VEN_CLIENTE_ID = C.CLI_ID
        WHERE V.VEN_CLIENTE_ID = :P_ID_CLIENTE
        ORDER BY V.VEN_DATA DESC
    INTO :NOME_CLIENTE, :VENDA_ID, :PRODUTO, :VALOR_TOTAL, :DATA_VENDA
    DO
    BEGIN
        SUSPEND;
    END
END

SELECT * FROM HIST_VENDAS_CLIENTE(27);


/* RETORNA CADA FORNECEDOR E O VALOR A PAGAR PARA CADA UM BASEADO NAS COMPRAS FEITAS NO PERÍODO SELECIONADO */
CREATE PROCEDURE CONTAS_A_PAGAR(
    P_DATA_INICIO DATE,
    P_DATA_FIM DATE
)
RETURNS (
	FORNECEDOR VARCHAR(30),
	VALOR_A_PAGAR NUMERIC(8,2)
)
AS
BEGIN
	FOR
		SELECT M.CMP_FORNECEDOR, SUM(M.CMP_VALOR_TOTAL) AS VALOR_A_PAGAR
		FROM COMPRAS M
		WHERE CMP_DATA BETWEEN :P_DATA_INICIO AND :P_DATA_FIM
		GROUP BY M.CMP_FORNECEDOR
		INTO :FORNECEDOR, :VALOR_A_PAGAR
	DO
		SUSPEND;
END

SELECT * FROM CONTAS_A_PAGAR('2025-03-01', '2025-04-02');



